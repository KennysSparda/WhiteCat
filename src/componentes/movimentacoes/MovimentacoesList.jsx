import React, { useState, useEffect } from 'react';
import MovimentacoesForm from './MovimentacoesForm';

const MovimentacoesSkeleton = () => {
  return (
    <>
      <tr className="animate-pulse">
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
      </tr>
      <tr className="animate-pulse">
      <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
      </tr>
      <tr className="animate-pulse">
      <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
      </tr>
      <tr className="animate-pulse">
      <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
      </tr>
      <tr className="animate-pulse">
      <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
      </tr>
      <tr className="animate-pulse">
      <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
      </tr>
      <tr className="animate-pulse">
      <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
      </tr>
      <tr className="animate-pulse">
      <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
        <td className="border border-gray-300 px-4 py-2 text-center">
          <div className="h-4 bg-gray-300 rounded w-3/4 mx-auto"></div>
        </td>
      </tr>
    </>
  );
};

const MovimentacoesList = () => {
  const [movimentacoes, setMovimentacoes] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isFormVisible, setIsFormVisible] = useState(false);
  const [currentMovimentacao, setCurrentMovimentacao] = useState(null);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(5);
  const [totalPages, setTotalPages] = useState(0);
  const [windowWidth, setWindowWidth] = useState(window.innerWidth);
  const [filtroGeral, setFiltroGeral] = useState('');
  const [dataInicial, setDataInicial] = useState('');
  const [dataFinal, setDataFinal] = useState('');

  useEffect(() => {
    fetchMovimentacoes();
    window.addEventListener('resize', handleResize);

    return () => {
      window.removeEventListener('resize', handleResize);
    };
  }, []);

  useEffect(() => {
    calculateItemsPerPage();
  }, [windowWidth]);

  useEffect(() => {
    calculateTotalPages();
  }, [movimentacoes, itemsPerPage, filtroGeral, dataInicial, dataFinal]);

  const fetchMovimentacoes = async () => {
    try {
      const response = await fetch(`${process.env.NEXT_PUBLIC_URL}/movimentacoes`);
      if (!response.ok) {
        throw new Error('Failed to fetch movimentacoes');
      }
      const data = await response.json();
      setMovimentacoes(data);
    } catch (error) {
      console.error('Error fetching movimentacoes:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const addMovimentacao = () => {
    setCurrentMovimentacao(null);
    setIsFormVisible(true);
  };

  const handleSubmit = async (movimentacaoData) => {
    try {
      const url = currentMovimentacao
        ? `${process.env.NEXT_PUBLIC_URL}/movimentacoes/${currentMovimentacao.id}`
        : `${process.env.NEXT_PUBLIC_URL}/movimentacoes`;

      const method = currentMovimentacao ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(movimentacaoData),
      });

      if (!response.ok) {
        throw new Error('Failed to submit movimentacao');
      }

      fetchMovimentacoes();
      setIsFormVisible(false);
    } catch (error) {
      console.error('Error submitting movimentacao:', error);
    }
  };

  const formatDate = (dateString) => {
    const regex = /(\d{4})-(\d{2})-(\d{2})/;
    const match = dateString.match(regex);

    if (!match) {
      throw new Error('Invalid date format');
    }

    const [_, year, month, day] = match;

    return `${day}/${month}/${year}`;
  };

  const calculateTotalPages = () => {
    const filteredMovimentacoes = filterMovimentacoes();
    const totalPagesCount = Math.ceil(filteredMovimentacoes.length / itemsPerPage === 0 ? 1 : filteredMovimentacoes.length / itemsPerPage);
    setTotalPages(totalPagesCount > 0 ? totalPagesCount : 1);
    if (currentPage > totalPagesCount) {
      setCurrentPage(totalPagesCount);
    }
  };

  const calculateItemsPerPage = () => {
    setItemsPerPage(getItemsPerPage());
  };

  const getItemsPerPage = () => {
    const screenWidth = window.innerWidth;
    if (screenWidth >= 1280) {
      return 10;
    } else if (screenWidth >= 768) {
      return 7;
    } else {
      return 5;
    }
  };

  const handleResize = () => {
    setWindowWidth(window.innerWidth);
  };

  const handleFilterChange = (event) => {
    setFiltroGeral(event.target.value);
  };

  const handleDataInicialChange = (event) => {
    setDataInicial(event.target.value);
  };

  const handleDataFinalChange = (event) => {
    setDataFinal(event.target.value);
  };

  const filterMovimentacoes = () => {
    return movimentacoes.filter((movimentacao) => {
      const movimentacaoDate = new Date(movimentacao.data);
      const initialDate = dataInicial ? new Date(dataInicial) : null;
      const finalDate = dataFinal ? new Date(dataFinal) : null;

      // Verifica se a movimentação está dentro do intervalo de datas selecionado
      return (
        (!initialDate || movimentacaoDate >= initialDate) &&
        (!finalDate || movimentacaoDate <= finalDate) &&
        (movimentacao.data.includes(filtroGeral) ||
          movimentacao.nomeproduto.toLowerCase().includes(filtroGeral.toLowerCase()) ||
          movimentacao.nomefuncionario.toLowerCase().includes(filtroGeral.toLowerCase()) ||
          movimentacao.nomeestoque.toLowerCase().includes(filtroGeral.toLowerCase()))
      );
    });
  };

  useEffect(() => {
    const today = new Date();
    const formattedDate = today.toISOString().substr(0, 10); // Formato YYYY-MM-DD
    setDataInicial(formattedDate);
    setDataFinal(formattedDate);
  }, []);

  const filteredMovimentacoes = filterMovimentacoes();
  const indexOfLastItem = currentPage * itemsPerPage;
  const indexOfFirstItem = indexOfLastItem - itemsPerPage;
  const currentItems = filteredMovimentacoes.slice(indexOfFirstItem, indexOfLastItem);

  const nextPage = () => {
    if (currentPage < totalPages) {
      setCurrentPage(currentPage + 1);
    }
  };

  const prevPage = () => {
    if (currentPage > 1) {
      setCurrentPage(currentPage - 1);
    }
  };

  const firstPage = () => {
    setCurrentPage(1);
  };

  const lastPage = () => {
    setCurrentPage(totalPages);
  };

  return (
    <div>
      <h2 className="text-2xl font-bold mb-4">Lista de Movimentações</h2>
      <div className="flex justify-between items-center mb-4">
        <button
          className="bg-green-500 text-white px-4 py-2 rounded"
          onClick={addMovimentacao}
        >
          Adicionar Movimentação
        </button>
        <div>
          <div className="flex items-center ">
            <label htmlFor="filtroGeral" className="ml-4 mr-2">Buscar:</label>
            <input
              type="text"
              id="filtroGeral"
              value={filtroGeral}
              onChange={handleFilterChange}
              className="border border-gray-300 px-2 py-1 rounded"
            />
            <label htmlFor="dataInicial" className=" ml-4 mr-2">Data Inicial:</label>
            <input
              type="date"
              id="dataInicial"
              value={dataInicial}
              onChange={handleDataInicialChange}
              className="border border-gray-300 px-2 py-1 rounded"
            />

            <label htmlFor="dataFinal" className="ml-4 mr-2">Data Final:</label>
            <input
              type="date"
              id="dataFinal"
              value={dataFinal}
              onChange={handleDataFinalChange}
              className="border border-gray-300 px-2 py-1 rounded"
            />
          </div>
        </div>
      </div>
      <div className="overflow-x-auto">
        <table className="min-w-full bg-white border border-gray-300">
          <thead>
            <tr>
              <th className="border border-gray-300 px-4 py-2">ID</th>
              <th className="border border-gray-300 px-4 py-2">Data</th>
              <th className="border border-gray-300 px-4 py-2">Produto</th>
              <th className="border border-gray-300 px-4 py-2">Funcionário</th>
              <th className="border border-gray-300 px-4 py-2">Tipo</th>
              <th className="border border-gray-300 px-4 py-2">Quantidade</th>
              <th className="border border-gray-300 px-4 py-2">Estoque</th>
            </tr>
          </thead>
          <tbody>
            {isLoading ? (
              <MovimentacoesSkeleton />
            ) : (
              currentItems.map((movimentacao) => (
                <tr key={movimentacao.id}>
                  <td className="border border-gray-300 px-4 py-2 text-center">{movimentacao.id}</td>
                  <td className="border border-gray-300 px-4 py-2 text-center">{formatDate(movimentacao.data)}</td>
                  <td className="border border-gray-300 px-4 py-2 text-center">{movimentacao.nomeproduto}</td>
                  <td className="border border-gray-300 px-4 py-2 text-center">{movimentacao.nomefuncionario}</td>
                  <td className={`border border-gray-300 px-4 py-2 text-center ${movimentacao.fk_tipomovimentacoes_id === 1 ? 'text-green-500' : 'text-red-500'}`}>
                    {movimentacao.fk_tipomovimentacoes_id === 1 ? 'Entrada' : 'Saída'}
                  </td>
                  <td className="border border-gray-300 px-4 py-2 text-center">{movimentacao.quantidade}</td>
                  <td className="border border-gray-300 px-4 py-2 text-center">{movimentacao.nomeestoque}</td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
      <div className="mt-4 flex justify-center items-center">
        <button
          className={`px-3 py-1 rounded ${currentPage === 1 ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-500 text-white'}`}
          onClick={firstPage}
          disabled={currentPage === 1}
        >
          Primeira
        </button>
        <button
          className={`ml-2 px-3 py-1 rounded ${currentPage === 1 ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-500 text-white'}`}
          onClick={prevPage}
          disabled={currentPage === 1}
        >
          Anterior
        </button>
        <span className="mx-4">
          Página {currentPage} de {totalPages}
        </span>
        <button
          className={`px-3 py-1 rounded ${currentPage === totalPages ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-500 text-white'}`}
          onClick={nextPage}
          disabled={currentPage === totalPages}
        >
          Próxima
        </button>
        <button
          className={`ml-2 px-3 py-1 rounded ${currentPage === totalPages ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-500 text-white'}`}
          onClick={lastPage}
          disabled={currentPage === totalPages}
        >
          Última
        </button>
      </div>
      {isFormVisible && (
        <MovimentacoesForm
          onSubmit={handleSubmit}
          onClose={() => setIsFormVisible(false)}
          movimentacao={currentMovimentacao}
        />
      )}
    </div>
  );
};

export default MovimentacoesList;